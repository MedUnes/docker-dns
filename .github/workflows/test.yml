name: Test Pipeline

on: [ push, pull_request ]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.21

      - name: Run Unit Tests
        run: go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...

  integration-tests:
    needs: unit-tests
    runs-on: ubuntu-latest
    services:
      docker:
        image: docker:dind
        options: --privileged
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.21

      - name: Start Docker
        run: |
          docker version
          docker run -d --name test-nginx nginx:alpine

      - name: Run Integration Tests
        run: go run gotest.tools/gotestsum@latest --format=testdox -- -tags=integration -v

  debian-install-test:
    # Depend on both build (for the .deb) and integration tests
    needs: [ integration-tests ]
    runs-on: ubuntu-latest
    container:
      # Corrected: Use the official ubuntu:22.04 image
      image: ubuntu:22.04
      # Options to allow systemd and Docker-in-Docker to function
      options: --privileged --tmpfs /run --tmpfs /run/lock -v /sys/fs/cgroup:/sys/fs/cgroup:ro
    services:
      docker:
        image: docker:dind # Docker-in-Docker service
        options: --privileged # dind needs privileged mode
    steps:
      - uses: actions/checkout@v4
      - name: Install Dependencies and docker-dns
        run: |
          # Update package lists
          apt-get update
          # Install necessary tools: systemd, bats, dnsutils, docker client CLI.
          DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends systemd bats dnsutils docker.io
          # Install the downloaded deb package
          # Use || true on dpkg and apt-get install -f in case dependencies are already met
          # dpkg -i ./docker-dns.deb || true
          apt-get install --fix-broken -y # Install any missing dependencies for the deb

      - name: Configure systemd-resolved and Run E2E Tests
        env:
          DOCKER_HOST: tcp://docker:2375
        run: |
          # Fix DNS resolution for docker hostname
          echo "Setting up DNS resolution:"
          echo "nameserver 127.0.0.53" > /etc/resolv.conf
          echo "options edns0 trust-ad" >> /etc/resolv.conf
          echo "search ." >> /etc/resolv.conf
          
          # Add docker host to hosts file as fallback
          echo "Adding docker host entry:"
          echo "172.17.0.1 docker" >> /etc/hosts
          
          # Verify DNS configuration
          echo "DNS Configuration:"
          resolvectl status
          cat /etc/resolv.conf
          cat /etc/hosts
          
          # Restart systemd-resolved
          systemctl restart systemd-resolved
          sleep 2
          
          # Test DNS resolution
          echo "Testing docker host resolution:"
          nslookup docker || true
          dig docker +short || true
          
          # Wait for Docker daemon (using direct connection)
          echo "Waiting for Docker socket..."
          timeout=30
          while ! docker -H tcp://docker:2375 info >/dev/null 2>&1; do
            sleep 1
            timeout=$((timeout-1))
            [ $timeout -le 0 ] && echo "Docker timeout" && exit 1
          done
          
          # Continue with tests...